%!TEX root = ../dokumentation.tex

\chapter{Implementierung}

\section{Ausgangslage}

\section{Simulation als Datenproduktion}
Strecke modelieren
Man kann in der Simulation Strecken aufbauen. Dazu wird auch zu jeder Strecke eine Ideallinie für das Fahrzeug generiert.
Diese Strecke besteht aus einer Liste von Punkten.
Das Modul AutomaticDrive kann genutzt werden damit das Fahrzeug entlang dieser Strecke fährt.
Das Fahrzeug fährt dann aber in gerader Linie von Punkt zu Punkt. 
Dadurch kommt es in Kurven zu einem ruckeligen Fahrverhalten.
WIE LÖST MAN DAS PROBLEM. INTERPOLATION IN KURVEN BEI AUTODRIVE

Bisher funktioniert die Simulation so dass das Fahrzeug um den Vorderachsenmittelpunkt V rotiert wird.
Das Fahrzeug bildet eine Tangente zu Fahrspur am Vorderachsenmittelpunkt V.
Dadurch ist die Kamera, die vorne am Fahrzeug montiert ist, zu weit in die Kurve rotiert.
Bei einer Kurve sieht das dann so aus:
BILD1
Ein realistischers Abbild ist es, wenn das Fahrzeug eine Sekante mit dem Vorderachsenmittelpunkt V, dem Hinterachsenmittelpunkt und der Fahrspur bildet.
In Kurven sind dann sowohl Vorderräder als auch Hinterräder auf der Fahrbahn.
Dies ermöglicht eine genauere Orientierung für die Kamera.
Um von der alten Orientierung auf die Neue zu kommen muss eine zusätzliche Rotation um den Vorderachsenmittelpunkt V addiert werden
Der Ziel ist es den Hinterachsenmittelpunkt H auf die Fahrspur zu verschieben.
Der Abstand zwischen H und V ist die Fahrzeuglänge l.
Bedingung ist es das sich die Fahrzeuglänge l nicht verändert.
Um den neuen Punkt HNeu zu finden wird der Schnittpunkt eines Kreises um V mit Radius l, mit der Fahrspur bestimmt.
Den Winkel $\alpha$ ergibt sich aus den drei Punkten $\sphericalangle$ HVHNeu. 
Die Rotation $\alpha$ um V wird auf das gesamte Fahrzeug angewendet.
BILD2
Im Vergleich von BILD1 und BILD2 wird deutlich wie sich der Winkel der Kamera ändert, welche auf Punkt V montiert ist.


Kamera entlang der Strecke fahren lassen

Um Algorithmen und Model in der Spurerkennung und Situationsklassifizierung zu verifizieren und verbessern, 
benötigt der Auto drive noch eine Möglichkeit den Lenkwinkel auszugeben.
Durch die realistischere Darstellung ist es nun trivial den Lenkwinkel zu bestimmen.
Die Vorderräder sind ausgerichtet entlang der Tangente VT am Punkt V zur Fahrspur.
Der Lenkwinkel $\beta$ ist der Winkel zwischen VT und der Richtung des Fahrzeugs. 


\section{Kamera}
Auflösung, Position, FoV eingestellt.

Die Auflösung der Kamera ist 2x2 Pixel.
Die Position und Orientierung der Kamera wird genau ermittelt, um die simulierte Kamera an die selbe Position zu bringen.
 

Problem: Für die IPM umrechnung muss der Kamerafeed sehr genau den echten wiederspiegeln.
Neue matrix wäre eine Scheiß Lösung.


\section{statische Fortbewegung}
Problem: Lenkwinkel muss irgendwie in eine Transformation des Fahrzeugs umgewandelt werden.
Der genaue Lösung wäre eine dynamische Simulation der Räder und Lenkung.
Dies war nicht so einfach abzustimmen, da sich die Simulation anders Verhalten hat als das echte Fahrzeug.
Vorläufige Lösung: Eine Rechnung die die Transformation abschätzt, aber sehr genau ist bei kleinen Lenkwinkel und hoher Fps.

Gegeben ist der Lenkwinkel alpha
Die Geschwindigkeit des Fahrzeugs v
Der daraus resultierende Vektor Lenkrichtung steering
Position des Fahrzeugs p
Orientierung des Fahrzeugs und der daraus resultierende Vektor direction

Als erstes wird aus dem Lenkwinkel alpha der Vektor steering bestimmt.
Danach wird die neue Position pNeu bestimmt mit pNeu = p + steering * (deltaTime * v)
Die neue Orientierung des Fahrzeugs directionNeu wird erechnet mit directionNeu = direction rotieren um k*alpha
dabei ist k Abhängig von der gefahrenen Strecke, sowie der Fahrzeuglänge.

\section{dynamische Fortbewegung}
Vier drehende Räder, Antrieb, Lenkung vorne.
Problem mit, Kräften, massen, Kollision...
on...

Die Räder des Fahrzeugs werden definiert innerhalb einem Link.
Jeder der vier Links besitzt eine visuelle Komponente und ein Kollisions-Komponente.
Das visuelle Objekt und das Kollisions-Objekt stimmen überein, beide definieren den gleichen Zylinder.
Jeder physikalisch simulierte Link benötigt einen inertial-Tag.
Dieser definiert die Masse "mass" und die Massenverteilung als inertia Tensor "inertia".

Damit sich ein Rad drehen kann, wird es mit einem Joint an dem Fahrzeug befestigt.
Der Joint definiert die beiden Links die verbunden werden sollen: child und parent.
Der Typ des Joints ist für die Räder "continuos". Das bedeuted, dass sich die Räder ohne Einschränkung um eine Achse drehen können.
Der Joint definiert außerdem die Position und Orientierung der Achse.

DiskJoints.

BRAUCHT MAN TRANSMISSIONS ÜBERHAUPT, ODER REICHEN CONTROLLER AUF JOINTS?
Um die Räder und die Länkung zu steuern, benötigt es einen Motor. 
Für urdf gibt es hierfür Actuator und Transmissions.
Eine Transmission verbindet einen Actuator mit einem Joint. 

PID 
Wie funktioniert PID???

Für die Lenkung soll der 